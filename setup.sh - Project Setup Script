#!/bin/bash

# Hip Hop Legends Beat Maker - Project Setup Script
# This script creates the complete project structure

set -e

echo "ðŸŽµ Hip Hop Legends Beat Maker - Project Setup"
echo "=============================================="
echo ""

# Colors
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
NC='\033[0m'

# Project name
PROJECT_NAME="hip-hop-beat-maker"

# Create project directory
echo -e "${BLUE}ðŸ“ Creating project directory...${NC}"
mkdir -p $PROJECT_NAME
cd $PROJECT_NAME

# Create public directory
echo -e "${BLUE}ðŸ“ Creating public directory...${NC}"
mkdir -p public

# Create placeholder for index.html
echo -e "${YELLOW}âš ï¸  IMPORTANT: You need to manually create public/index.html${NC}"
echo -e "${YELLOW}   Copy the HTML artifact content into: public/index.html${NC}"
echo ""

# Create package.json
echo -e "${BLUE}ðŸ“ Creating package.json...${NC}"
cat > package.json << 'EOF'
{
  "name": "hip-hop-legends-beat-maker",
  "version": "1.0.0",
  "description": "AI-powered Hip Hop beat maker with sample upload",
  "main": "server.js",
  "scripts": {
    "start": "node server.js",
    "dev": "nodemon server.js"
  },
  "keywords": [
    "beat-maker",
    "hip-hop",
    "music",
    "production"
  ],
  "author": "Jay's Frames",
  "license": "MIT",
  "dependencies": {
    "express": "^4.18.2",
    "compression": "^1.7.4",
    "helmet": "^7.1.0"
  },
  "devDependencies": {
    "nodemon": "^3.0.2"
  },
  "engines": {
    "node": ">=18.0.0"
  }
}
EOF

# Create server.js
echo -e "${BLUE}ðŸ“ Creating server.js...${NC}"
cat > server.js << 'EOF'
const express = require('express');
const compression = require('compression');
const helmet = require('helmet');
const path = require('path');

const app = express();
const PORT = process.env.PORT || 3000;

// Security middleware
app.use(helmet({
  contentSecurityPolicy: {
    directives: {
      defaultSrc: ["'self'"],
      scriptSrc: ["'self'", "'unsafe-inline'"],
      styleSrc: ["'self'", "'unsafe-inline'", "https://fonts.googleapis.com"],
      fontSrc: ["'self'", "https://fonts.gstatic.com"],
      connectSrc: ["'self'", "https://api.anthropic.com"],
      imgSrc: ["'self'", "data:", "blob:"],
      mediaSrc: ["'self'", "blob:"]
    }
  }
}));

// Compression middleware
app.use(compression());

// Serve static files
app.use(express.static(path.join(__dirname, 'public')));

// Health check endpoint
app.get('/health', (req, res) => {
  res.status(200).json({ status: 'healthy', timestamp: new Date().toISOString() });
});

// Catch-all route
app.get('*', (req, res) => {
  res.sendFile(path.join(__dirname, 'public', 'index.html'));
});

// Error handling
app.use((err, req, res, next) => {
  console.error('Server error:', err);
  res.status(500).json({ error: 'Internal server error' });
});

// Start server
app.listen(PORT, '0.0.0.0', () => {
  console.log(`ðŸŽµ Hip Hop Legends Beat Maker running on port ${PORT}`);
  console.log(`ðŸš€ Environment: ${process.env.NODE_ENV || 'development'}`);
  console.log(`ðŸŒ Server ready at http://localhost:${PORT}`);
});
EOF

# Create railway.toml
echo -e "${BLUE}ðŸ“ Creating railway.toml...${NC}"
cat > railway.toml << 'EOF'
[build]
builder = "NIXPACKS"

[deploy]
startCommand = "npm start"
restartPolicyType = "ON_FAILURE"
restartPolicyMaxRetries = 10

[[deploy.healthcheck]]
path = "/health"
interval = 30
timeout = 10
EOF

# Create .gitignore
echo -e "${BLUE}ðŸ“ Creating .gitignore...${NC}"
cat > .gitignore << 'EOF'
# Dependencies
node_modules/
npm-debug.log*
yarn-debug.log*
yarn-error.log*

# Environment variables
.env
.env.local
.env.*.local

# OS files
.DS_Store
Thumbs.db

# IDE
.vscode/
.idea/
*.swp
*.swo
*~

# Logs
logs/
*.log

# Runtime
pids/
*.pid
*.seed
*.pid.lock

# Build outputs
dist/
build/
EOF

# Create README
echo -e "${BLUE}ðŸ“ Creating README.md...${NC}"
cat > README.md << 'EOF'
# ðŸŽµ Hip Hop Legends Beat Maker

AI-powered beat maker with sample upload functionality, inspired by legendary hip hop producers.

## Quick Start

1. Copy the HTML artifact content to `public/index.html`
2. Install dependencies: `npm install`
3. Run locally: `npm run dev`
4. Deploy to Railway: `railway init && railway up`

## Features

- AI-powered beat generation
- Sample upload and assignment
- 16-step sequencer
- Professional audio synthesis
- Loop mode and tempo control

See full documentation in the deployment guide artifact.
EOF

# Make deploy script executable
echo -e "${BLUE}ðŸ“ Creating deploy.sh...${NC}"
cat > deploy.sh << 'EOF'
#!/bin/bash
set -e
echo "ðŸš€ Deploying to Railway..."
railway login
railway init
railway up
railway domain
echo "âœ… Deployment complete!"
EOF
chmod +x deploy.sh

echo ""
echo -e "${GREEN}=============================================="
echo "âœ… Project Setup Complete!"
echo "==============================================\\${NC}"
echo ""
echo -e "${YELLOW}ðŸ“‹ Next Steps:${NC}"
echo "1. Copy the HTML artifact content to: public/index.html"
echo "2. Install dependencies: npm install"
echo "3. Test locally: npm run dev"
echo "4. Deploy to Railway: ./deploy.sh"
echo ""
echo -e "${BLUE}ðŸ“‚ Project Structure:${NC}"
echo "hip-hop-beat-maker/"
echo "â”œâ”€â”€ public/"
echo "â”‚   â””â”€â”€ index.html      ${YELLOW}(âš ï¸  COPY HTML ARTIFACT HERE)${NC}"
echo "â”œâ”€â”€ server.js"
echo "â”œâ”€â”€ package.json"
echo "â”œâ”€â”€ railway.toml"
echo "â”œâ”€â”€ .gitignore"
echo "â”œâ”€â”€ deploy.sh"
echo "â””â”€â”€ README.md"
echo ""
echo -e "${GREEN}ðŸŽ¤ Ready to make beats! ðŸ”¥${NC}"
